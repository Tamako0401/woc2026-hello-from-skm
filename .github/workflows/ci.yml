name: woc2026 CI

on:
  push:
  pull_request:

permissions:
  contents: read
  packages: write
    
jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          clang-15 \
          lld \
          llvm-15 \
          libelf-dev \
          libssl-dev \
          bc \
          flex \
          bison \
          qemu-system-x86 \
          cpio

    - name: Install Rust toolchain
      run: |
        curl https://sh.rustup.rs -sSf | sh -s -- -y
        source $HOME/.cargo/env
        rustup toolchain install 1.88.0
        rustup default 1.88.0
        cargo install bindgen-cli --version 0.65.1

    - name: Build project
      run: |
        source $HOME/.cargo/env

        export PATH=/usr/lib/llvm-15/bin:$PATH
        export LLVM=1
        export LLVM_IAS=1
        export LLVM_VERSION=15
        clang --version
        
        make setup
        make build

    - name: Smoke test (boot kernel)
      run: |
        source $HOME/.cargo/env
        chmod +x scripts/run.sh

        timeout 30s ./scripts/run.sh -k linux -b busybox | tee qemu.log || true
        grep -q "Welcome to" qemu.log

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: woc2026-build
        path: |
          linux/arch/x86_64/boot/bzImage
          busybox/rootfs.img
          src/*.ko
          tools/*.a

    - name: Log in to GitHub Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image
      if: github.event_name != 'pull_request'
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile
        push: true
        tags: ghcr.io/${{ github.repository }}:latest
